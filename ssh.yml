---
  - name: Copy sshd_config
    copy:
      src: ssh/sshd_config
      dest: /etc/ssh/sshd_config

  - name: Add Allowed Users
    blockinfile:
      create: true
      owner: root
      group: root
      mode: 0664
      path: /etc/ssh/sshd_config.d/allowed_users.conf
      block: AllowUsers {{ ssh_users }}
    register: allowed_users

  - name: Start sshd
    service:
      name: sshd
      enabled: true
      state: started

  - name: Reload sshd
    service:
      name: sshd
      state: reloaded
    when: allowed_users.changed | bool
